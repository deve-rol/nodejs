<!doctype html>
<html lang="en">
  <head>
      <meta charset="utf-8">
      <meta name="description" content="alphasec">
      <meta name="author" content="alphasec">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <title>alphasec</title>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/styles.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:500&display=swap">
      <link rel="icon" href="/favicon.ico" type="image/x-icon">
  </head>
  <body>
    <video id="local" controls autoplay></video>
<video id="remote" controls autoplay></video>

<button id="start-btn">Start</button>
    <script>
      const ws = new WebSocket('ws://localhost:3000'); // твой WebSocket сервер
const startBtn = document.getElementById('start-btn');

// Send stream
startStream = () => {
    console.log('startStream');
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            console.log(2222);
            const videoElement = document.querySelector('video#local');
            videoElement.srcObject = stream;
            videoElement.play();

            const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8' });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    // Отправка чанка на сервер
                    ws.send(event.data);
                }
            };

            mediaRecorder.start(100); // 100ms чанки
        })
        .catch(console.error);
}

startBtn.addEventListener('click', startStream);

// Handle remote stream
const videoElement = document.querySelector('video#remote');
const mediaSource = new MediaSource();
videoElement.src = URL.createObjectURL(mediaSource);

mediaSource.addEventListener('sourceopen', () => {
    const sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8, opus"');

    console.log(222);
    ws.onmessage = (event) => {
        console.log(event.data, 111);
        const reader = new FileReader();
        reader.onload = () => {
            sourceBuffer.appendBuffer(new Uint8Array(reader.result));
        };
        reader.readAsArrayBuffer(event.data);
    };
});
    </script>
  </body>
</html>
